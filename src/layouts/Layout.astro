---
import OnlineCounter from "../components/Watcher/OnlineCounter.svelte";
import { getOnlineVisitorCount } from "../server/watcher";
import ThemeInit from "../styles/ThemeInit.astro";
import { defaultTheme } from "../styles/config";
import ThemeSelector from "../styles/ThemeSelector.svelte";
import baseStylesUrl from "../styles/base.css?url";
import resetStylesUrl from "../styles/reset.css?url";

const {
    header,
    title,
    description,
    colour,
    ogImage,
    ogType = "website",
    twitterCard = "summary_large_image",
} = Astro.props;
const keywords =
    "LaTeX 4000, LaTeX, latex, 4000, collective, webring, art, music, organization, design, web";
const schema = JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Organization",
    name: "LaTeX 4000",
    description: "A collective webring of friends making things.",
    url: Astro.url.toString(),
    keywords,
    logo: new URL("/logo.png", Astro.url).toString(),
});

const onlineCount = await getOnlineVisitorCount(Astro);

/* eslint-disable astro/jsx-a11y/anchor-is-valid */
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <link rel="sitemap" href="/sitemap.xml" />
        <link rel="canonical" href={Astro.url} />
        <link
            rel="alternate"
            type="application/rss+xml"
            title="LaTeX 4000's RSS Feed"
            href={new URL("/rss.xml", Astro.url)}
        />
        <link
            rel="alternate"
            type="application/rss+xml"
            title="LaTeX 4000's Sounds RSS Feed"
            href={new URL("/rss_sounds.xml", Astro.url)}
        />
        <link
            rel="alternate"
            type="application/rss+xml"
            title="LaTeX 4000's Sights RSS Feed"
            href={new URL("/rss_sights.xml", Astro.url)}
        />
        <link
            rel="alternate"
            type="application/rss+xml"
            title="LaTeX 4000's Motions RSS Feed"
            href={new URL("/rss_motions.xml", Astro.url)}
        />
        <link
            rel="alternate"
            type="application/rss+xml"
            title="LaTeX 4000's Words RSS Feed"
            href={new URL("/rss_words.xml", Astro.url)}
        />
        <title>{title || "LaTeX 4000"}</title>
        <meta
            name="description"
            content={description || "LaTeX 4000 Collective"}
        />
        <meta name="author" content="LaTeX 4000" />
        <meta name="keywords" content={keywords} />
        <meta
            name="theme-color"
            content={colour ?? defaultTheme.values["--background-color"]}
        />

        <meta name="twitter:card" content={twitterCard} />
        <meta name="twitter:site" content="@Latex4000" />
        <meta name="twitter:title" content={title || "LaTeX 4000"} />
        <meta
            name="twitter:description"
            content={description || "LaTeX 4000 Collective"}
        />
        <meta
            name="twitter:image"
            content={ogImage ?? new URL("/logo.png", Astro.url)}
        />
        <meta name="twitter:image:alt" content={title || "LaTeX 4000"} />

        <meta property="og:title" content={title || "LaTeX 4000"} />
        <meta property="og:type" content={ogType} />
        <meta property="og:url" content={Astro.url} />
        <meta
            property="og:image"
            content={ogImage ?? new URL("/logo.png", Astro.url)}
        />
        <meta property="og:image:alt" content={title || "LaTeX 4000"} />
        <meta
            property="og:description"
            content={description || "LaTeX 4000 Collective"}
        />
        <meta property="og:site_name" content="LaTeX 4000" />
        <meta property="og:locale" content="en_US" />

        <script is:inline type="application/ld+json" set:html={schema} />

        <link data-reset-styles href={resetStylesUrl} rel="stylesheet" />
        <link data-base-styles href={baseStylesUrl} rel="stylesheet" />
        <ThemeInit />
    </head>
    <body data-theme={defaultTheme.slug}>
        <header>
            <div class="title-bar">
                <h1>
                    <a href="/" class="latex"
                        >L<span>a</span>T<span>e</span>X 4000 / L4K</a
                    >
                </h1>
                <div class="title-bar__right">
                    <OnlineCounter client:load initialCount={onlineCount} />
                    <ThemeSelector client:load />
                </div>
            </div>
            <nav>
                <div class="ch">
                    <span style="white-space: pre;"
                        ><a href="/random">!ch</a>
                    </span>
                    <div class="ch__hover">
                        <span style="white-space: pre;"
                            ><a href="#" class="js-roll">!roll</a>
                        </span><br />
                        <span style="white-space: pre;"
                            ><a href="#" class="js-shouldi">!shouldi</a>
                        </span>
                    </div>
                </div>
                <div class="command-results js-command-results"></div>
                <a href="/">Home</a>
                |
                <a href="/sounds">Sounds</a>
                |
                <a href="/words">Words</a>
                |
                <a href="/motions">Motions</a>
                |
                <a href="/sights">Sights</a>
                |
                <a href="/actions">Actions</a>
                |
                <a href="/things">Things</a>
            </nav>
            <h2>{header}</h2>
        </header>
        <main>
            <slot />
        </main>
        <footer>
            <div class="webring">
                <div>Web ring</div>
                <div>
                    <a
                        class="webring__prev"
                        href="/ring?action=prev&from=LaTeX 4000"
                        title="Previous"></a>
                    <a href="/ring?action=rand&from=LaTeX 4000">Random</a>
                    <a
                        class="webring__next"
                        href="/ring?action=next&from=LaTeX 4000"
                        title="Next"></a>
                </div>
            </div>
            <div class="footer-info">
                <div>
                    <div class="latex">
                        L<span>a</span>T<span>e</span>X 4000 Collective
                    </div>
                    <div>
                        <a href="https://www.youtube.com/@latex4000">YouTube</a>
                        |
                        <a href="https://soundcloud.com/latex4000">SoundCloud</a
                        >
                        |
                        <a href="https://github.com/Latex4000">GitHub</a>
                        |
                        <a href="https://nonacademic.net/rss.xml">RSS</a>
                    </div>
                </div>
                <div>
                    <a href={defaultTheme.values["--srclink"]} id="style-source"
                        >{defaultTheme.values["--srctext"]}</a
                    >
                </div>
            </div>
        </footer>
    </body>
</html>

<script>
    // Formats timestamps for any <time data-format="localized"> nodes
    const formatElement = (element: HTMLTimeElement): void => {
        if (element.dataset.formattedValue) return;

        const value =
            element.getAttribute("datetime") || element.dataset.timestamp;
        if (!value) return;

        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return;

        const locale = navigator.language || "en-US";
        const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

        try {
            const formatter = new Intl.DateTimeFormat(locale, {
                year: "numeric",
                month: "short",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit",
                timeZone,
            });

            const formatted = formatter.format(date);
            if (element.dataset.formattedValue === formatted) return;

            element.textContent = formatted;
            element.dataset.formattedValue = formatted;
        } catch (error) {
            console.warn("Failed to format date", error);
        }
    };

    const formatAll = (): void => {
        document
            .querySelectorAll<HTMLTimeElement>("time[data-format='localized']")
            .forEach((element) => formatElement(element));
    };

    const observer = new MutationObserver(formatAll);

    const init = (): void => {
        formatAll();
        observer.observe(document.body, {
            childList: true,
            subtree: true,
        });
    };

    document.addEventListener("DOMContentLoaded", init);
</script>

<style>
    header {
        margin-block: var(--layout-header-margin-block, 1lh);
    }

    header h1 {
        margin: 0;
    }

    header h1 a {
        text-decoration: none;
    }

    nav {
        margin-block: var(--space-sm);
        position: relative;
    }

    main {
        /* For slotted components that need to use absolute positioning */
        position: relative;
    }

    footer {
        margin-block: var(--space-lg);
        font-size: var(--layout-footer-font-scale, 0.8em);
    }

    .title-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .title-bar__right {
        display: flex;
        align-items: center;
        gap: var(--space-inline-sm);
        margin-left: var(--space-inline-sm);
    }

    .ch {
        position: absolute;
        right: 100%;
        text-transform: none;
        text-align: right;
    }

    .ch__hover {
        display: none;
    }

    .ch:hover > .ch__hover {
        display: block;
    }

    .command-results {
        position: absolute;
        right: 100%;
        text-transform: none;
    }

    /* Global scope here is necessary due to the elements being created in JS */
    :global(.command-results > span) {
        position: absolute;
        color: var(--text-color-alt);
        animation:
            2s command-fade-out forwards ease-in,
            1.5s command-fly-left forwards ease-out;
        text-shadow: var(--background-color) 0 0 2px;
    }

    @keyframes command-fade-out {
        from {
            opacity: 1;
        }
        to {
            opacity: 0;
        }
    }

    @keyframes command-fly-left {
        from {
            transform: none;
        }
        to {
            transform: translateY(-10px);
        }
    }

    .webring {
        margin-bottom: var(--space-sm);
        text-align: center;
    }

    .webring__prev::after {
        content: var(--webring-prev-icon, "<--");
    }

    .webring__next::after {
        content: var(--webring-next-icon, "-->");
    }

    .footer-row {
        display: flex;
        justify-content: space-between;
    }

    .footer-info {
        display: flex;
        justify-content: space-between;
    }

    @media only screen and (max-width: 767px) {
        .footer-info {
            flex-direction: column;
            gap: var(--space-sm);
            text-align: center;
        }
    }

    @media only screen and (max-width: 600px) {
        .title-bar__right {
            flex-direction: column-reverse;
            align-items: end;
            gap: var(--space-xs);
        }
    }
</style>

<script>
    const commandResultsElement = document.querySelector<HTMLElement>(
        ".js-command-results"
    )!;

    function showResult(positionElement: HTMLElement, result: string): void {
        const element = document.createElement("span");
        element.style.top = `${positionElement.offsetTop}px`;
        element.style.right = `${positionElement.offsetWidth + 10}px`;
        element.innerText = result;

        commandResultsElement.appendChild(element);

        // After the CSS animation is complete
        setTimeout(() => element.remove(), 2000);
    }

    const rollElement = document.querySelector<HTMLElement>(".js-roll")!;
    const shouldiElement = document.querySelector<HTMLElement>(".js-shouldi")!;

    rollElement.addEventListener("click", (event) => {
        event.preventDefault();

        const result = Math.floor(Math.random() * 100) + 1;

        showResult(rollElement.parentElement!, result.toString());
    });

    shouldiElement.addEventListener("click", (event) => {
        event.preventDefault();

        const results = ["yes", "no", "idk"];
        const result = results[Math.floor(Math.random() * 3)]!;

        showResult(shouldiElement.parentElement!, result);
    });
</script>
