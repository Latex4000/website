---
import { and, eq } from "drizzle-orm";
import Layout from "../../layouts/Layout.astro";
import { readdir } from "fs/promises";
import db from "../../database/db";
import { Member, Sight } from "../../database/schema";

export const prerender = false;

if (!process.env.SIGHTS_UPLOAD_DIRECTORY) {
    return new Response("SIGHTS_UPLOAD_DIRECTORY not set", { status: 500 });
}

const sightResult = await db
    .select({
        sight: Sight,
        memberColor: Member.color,
    })
    .from(Sight)
    .leftJoin(Member, eq(Sight.memberDiscord, Member.discord))
    .where(
        and(
            eq(Sight.id, Number.parseInt(Astro.params.id!, 10)),
            eq(Sight.deleted, false)
        )
    )
    .get();

if (sightResult == null) {
    return new Response(null, { status: 404 });
}

const { memberColor, sight } = sightResult;
const sightsDirectory = `${process.env.SIGHTS_UPLOAD_DIRECTORY}/${sight.id}`;
const images = await readdir(sightsDirectory);
---

<Layout title={sight.title}>
    <small style={{ color: memberColor }}>{sight.description}</small>
    <small style={{ color: memberColor }}>{sight.date.toLocaleString()}</small>
    <div class="sight-images">
        {
            images.map((image) => (
                <img src={`/sights-uploads/${sight.id}/${image}`} alt={image} />
            ))
        }
    </div>
    <p style={{ color: memberColor }}>-L</p>
    <div class="tags">
        {sight.tags.map((tag) => <small>{tag}</small>)}
    </div>
</Layout>
