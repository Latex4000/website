---
import Layout from "../_Layout.astro";
---

<Layout>
    <h1>Submit a Sound üéµ</h1>
    <p>
        Upload an audio track along with artwork and optional video for social
        posts.
    </p>

    <form
        id="sound-form"
        action="/corp/api/sounds"
        method="post"
        enctype="multipart/form-data"
    >
        <label>
            Title
            <input type="text" name="title" required />
        </label>

        <label>
            Genre
            <input type="text" name="genre" required />
        </label>

        <label>
            Description
            <textarea name="description" rows="3"></textarea>
        </label>

        <label>
            Tags (comma separated)
            <input type="text" name="tags" />
        </label>

        <label>
            Audio File (mp3 or wav)
            <input
                type="file"
                name="audio"
                accept="audio/mpeg,audio/wav"
                required
            />
        </label>

        <label>
            Cover Image (png or jpg)
            <input
                type="file"
                name="image"
                accept="image/png,image/jpeg"
                required
            />
        </label>

        <label>
            Optional Video (mp4/mov/mkv/avi/wmv)
            <input type="file" name="video" accept="video/*" />
        </label>

        <label class="checkbox">
            <input type="checkbox" name="allowYoutubeShorts" />
            Allow YouTube Shorts
        </label>

        <label class="checkbox">
            <input type="checkbox" name="allowVerticalCover" />
            Allow vertical cover images
        </label>

        <label class="checkbox">
            <input type="checkbox" name="colour" checked />
            Show colour for this sound
        </label>

        <label class="checkbox">
            <input type="checkbox" name="confirmInformation" required />
            I confirm the information is correct
        </label>

        <label class="checkbox">
            <input type="checkbox" name="confirmOwnWork" required />
            This is my own work
        </label>

        <button type="submit" class="submit-button">
            <span class="button-text">Submit Sound</span>
            <span class="button-spinner" style="display: none;">‚è≥</span>
        </button>
    </form>

    <div id="upload-progress" class="upload-progress" style="display: none;">
        <div class="progress-bar">
            <div class="progress-fill"></div>
        </div>
        <p class="progress-text">Uploading... 0%</p>
    </div>

    <p id="sound-status" class="status" role="status" aria-live="polite"></p>
</Layout>

<script type="module">
    import { triggerConfetti, animateSuccess } from "../../../components/corp/confetti";

    const form = document.getElementById("sound-form");
    const status = document.getElementById("sound-status");
    const uploadProgress = document.getElementById("upload-progress");

    async function handleSubmit(event) {
        event.preventDefault();
        if (
            !(form instanceof HTMLFormElement) ||
            !(status instanceof HTMLElement)
        )
            return;

        const audioInput = form.querySelector('input[name="audio"]');
        const imageInput = form.querySelector('input[name="image"]');
        if (
            !(audioInput instanceof HTMLInputElement) ||
            !audioInput.files?.length ||
            !(imageInput instanceof HTMLInputElement) ||
            !imageInput.files?.length
        ) {
            status.textContent = "‚ùå Audio and cover image are required";
            status.className = "status status--error";
            return;
        }

        // Show loading state
        const button = form.querySelector("button[type='submit']");
        const buttonText = button?.querySelector(".button-text");
        const buttonSpinner = button?.querySelector(".button-spinner");
        if (button && buttonText && buttonSpinner) {
            button.disabled = true;
            buttonText.style.display = "none";
            buttonSpinner.style.display = "inline";
        }
        status.textContent = "‚è≥ Uploading files‚Ä¶";
        status.className = "status status--loading";

        // Show upload progress
        if (uploadProgress) {
            uploadProgress.style.display = "block";
        }

        try {
            const xhr = new XMLHttpRequest();
            
            // Track upload progress
            xhr.upload.addEventListener("progress", (e) => {
                if (e.lengthComputable && uploadProgress) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    const progressFill = uploadProgress.querySelector(".progress-fill");
                    const progressText = uploadProgress.querySelector(".progress-text");
                    if (progressFill instanceof HTMLElement) {
                        progressFill.style.width = percentComplete + "%";
                    }
                    if (progressText) {
                        progressText.textContent = `Uploading... ${Math.round(percentComplete)}%`;
                    }
                }
            });

            // Handle response
            const responsePromise = new Promise((resolve, reject) => {
                xhr.addEventListener("load", () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        resolve(xhr.responseText);
                    } else {
                        reject(new Error(xhr.statusText || "Upload failed"));
                    }
                });
                xhr.addEventListener("error", () => reject(new Error("Network error")));
                xhr.addEventListener("abort", () => reject(new Error("Upload cancelled")));
            });

            xhr.open("POST", form.action);
            xhr.send(new FormData(form));

            const text = await responsePromise;
            let payload;
            try {
                payload = JSON.parse(text);
            } catch {
                payload = null;
            }

            if (xhr.status >= 400) {
                const errorMessage =
                    payload && typeof payload === "object" && "error" in payload
                        ? payload.error
                        : text || "Request failed";
                status.textContent = `‚ùå ${String(errorMessage)}`;
                status.className = "status status--error";
                return;
            }

            status.textContent = "‚úÖ Uploaded successfully!";
            status.className = "status status--success";
            
            // Trigger success animations
            if (form) {
                animateSuccess(form);
                const rect = button?.getBoundingClientRect();
                if (rect) {
                    triggerConfetti(rect.left + rect.width / 2, rect.top + rect.height / 2);
                }
            }
            
            form.reset();
        } catch (error) {
            status.textContent = `‚ùå ${error instanceof Error ? error.message : "Unknown error"}`;
            status.className = "status status--error";
        } finally {
            // Reset button state
            if (button && buttonText && buttonSpinner) {
                button.disabled = false;
                buttonText.style.display = "inline";
                buttonSpinner.style.display = "none";
            }
            // Hide upload progress
            if (uploadProgress) {
                setTimeout(() => {
                    uploadProgress.style.display = "none";
                    const progressFill = uploadProgress.querySelector(".progress-fill");
                    if (progressFill instanceof HTMLElement) {
                        progressFill.style.width = "0%";
                    }
                }, 2000);
            }
        }
    }

    if (form) form.addEventListener("submit", handleSubmit);
</script>

<style>
    form {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    label {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        font-weight: 600;
    }

    input,
    textarea {
        padding: 0.5rem;
        border: 2px solid #333;
        border-radius: 4px;
        font-family: inherit;
        font-size: 1rem;
        transition: all 0.2s ease;
    }

    input:focus,
    textarea:focus {
        outline: none;
        border-color: #ebdf35;
        box-shadow: 0 0 0 3px rgba(235, 223, 53, 0.2);
    }

    input[type="file"] {
        padding: 0.4rem;
        cursor: pointer;
    }

    .checkbox {
        flex-direction: row;
        align-items: center;
        font-weight: normal;
        gap: 0.5rem;
    }

    .submit-button {
        align-self: flex-start;
        padding: 0.75rem 1.5rem;
        font-weight: 700;
        font-size: 1rem;
        background: #ebdf35;
        border: 2px solid black;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .submit-button:hover:not(:disabled) {
        background: #f7ef83;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .submit-button:active:not(:disabled) {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .submit-button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .button-spinner {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .upload-progress {
        margin: 1rem 0;
        padding: 1rem;
        background: #f5f5f5;
        border-radius: 6px;
        border: 2px solid #333;
    }

    .progress-bar {
        width: 100%;
        height: 24px;
        background: #ddd;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 0.5rem;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #ebdf35, #f7ef83);
        width: 0%;
        transition: width 0.3s ease;
        border-radius: 12px;
    }

    .progress-text {
        font-weight: 600;
        text-align: center;
        margin: 0;
    }

    .status {
        min-height: 1.5rem;
        font-weight: 600;
        padding: 0.75rem 1rem;
        border-radius: 6px;
        transition: all 0.3s ease;
    }

    .status--loading {
        background: #e3f2fd;
        border: 2px solid #2196f3;
        animation: pulse 1.5s ease-in-out infinite;
    }

    .status--success {
        background: #e8f5e9;
        border: 2px solid #4caf50;
        animation: slideIn 0.3s ease;
    }

    .status--error {
        background: #ffebee;
        border: 2px solid #f44336;
        animation: shake 0.5s ease;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
    }

    @keyframes successPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.02); }
    }
</style>
