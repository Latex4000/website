---
import Layout from "../_Layout.astro";
import "../../../styles/corp-submission-forms.css";
---

<Layout>
    <h1>Submit an Action ⚡</h1>
    <p>
        Share a link or RSS feed for the activity log. The corp API will pull
        the metadata for you.
    </p>

    <form id="action-form" action="/corp/api/actions" method="post">
        <label>
            Link
            <input type="url" name="link" placeholder="https://" required />
        </label>

        <fieldset>
            <legend>Type</legend>
            <label class="checkbox">
                <input type="radio" name="isRSS" value="false" checked />
                Single link or article
            </label>
            <label class="checkbox">
                <input type="radio" name="isRSS" value="true" />
                RSS feed
            </label>
        </fieldset>

        <label>
            Title override (optional)
            <input type="text" name="title" />
        </label>

        <label>
            Description override (optional)
            <textarea name="description" rows="3"></textarea>
        </label>

        <button type="submit" class="submit-button">
            <span class="button-text">Submit Action</span>
            <span class="button-spinner" style="display: none;">⏳</span>
        </button>
    </form>

    <p id="action-status" class="status" role="status" aria-live="polite"></p>
</Layout>

<script type="module">
    import { triggerConfetti, animateSuccess } from "../../../components/corp/confetti";

    const form = document.getElementById("action-form");
    const status = document.getElementById("action-status");

    async function handleSubmit(event) {
        event.preventDefault();
        if (
            !(form instanceof HTMLFormElement) ||
            !(status instanceof HTMLElement)
        )
            return;

        const linkInput = form.querySelector('input[name="link"]');
        if (
            !(linkInput instanceof HTMLInputElement) ||
            !linkInput.value.trim()
        ) {
            status.textContent = "❌ Link is required";
            status.className = "status status--error";
            return;
        }

        const rssInput = form.querySelector('input[name="isRSS"]:checked');
        const isRSS =
            rssInput instanceof HTMLInputElement && rssInput.value === "true";

        const payload = {
            link: linkInput.value.trim(),
            isRSS,
            title:
                (
                    form.querySelector('input[name="title"]')?.value || ""
                ).trim() || undefined,
            description:
                (
                    form.querySelector('textarea[name="description"]')?.value ||
                    ""
                ).trim() || undefined,
        };

        // Show loading state
        const button = form.querySelector("button[type='submit']");
        const buttonText = button?.querySelector(".button-text");
        const buttonSpinner = button?.querySelector(".button-spinner");
        if (button && buttonText && buttonSpinner) {
            button.disabled = true;
            buttonText.style.display = "none";
            buttonSpinner.style.display = "inline";
        }
        status.textContent = "⏳ Submitting…";
        status.className = "status status--loading";

        try {
            const response = await fetch(form.action, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });
            const text = await response.text();
            let parsed;
            try {
                parsed = JSON.parse(text);
            } catch {
                parsed = null;
            }

            if (!response.ok) {
                const errorMessage =
                    parsed && typeof parsed === "object" && "error" in parsed
                        ? parsed.error
                        : text || "Request failed";
                status.textContent = `❌ ${String(errorMessage)}`;
                status.className = "status status--error";
                return;
            }

            const title =
                parsed && typeof parsed === "object" && "title" in parsed
                    ? parsed.title
                    : null;
            status.textContent = title ? `✅ Posted ${title}` : "✅ Submitted successfully!";
            status.className = "status status--success";
            
            // Trigger success animations
            if (form) {
                animateSuccess(form);
                const rect = button?.getBoundingClientRect();
                if (rect) {
                    triggerConfetti(rect.left + rect.width / 2, rect.top + rect.height / 2);
                }
            }
            
            form.reset();
        } catch (error) {
            status.textContent = `❌ ${error instanceof Error ? error.message : "Unknown error"}`;
            status.className = "status status--error";
        } finally {
            // Reset button state
            if (button && buttonText && buttonSpinner) {
                button.disabled = false;
                buttonText.style.display = "inline";
                buttonSpinner.style.display = "none";
            }
        }
    }

    if (form) form.addEventListener("submit", handleSubmit);
</script>

<style>
    fieldset {
        border: 2px solid black;
        padding: 0.75rem 1rem;
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
    }

    legend {
        font-weight: 700;
        padding: 0 0.5rem;
    }
</style>
