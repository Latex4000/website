---
import { desc, eq, getTableColumns } from "drizzle-orm";
import Layout from "../../layouts/Layout.astro";
import db, { wordId } from "../../database/db";
import { Member, Word } from "../../database/schema";
import { thingColourHandler } from "../../server/thingUtils";

export const prerender = false;

const wordResults = await db
    .select({
        ...getTableColumns(Word),
        memberColor: Member.color,
    })
    .from(Word)
    .where(eq(Word.deleted, false))
    .innerJoin(Member, eq(Word.memberDiscord, Member.discord))
    .orderBy(desc(Word.id))
    .then(thingColourHandler);

const wordsSchema = {
    "@context": "https://schema.org",
    "@type": "ItemList",
    name: "Words",
    url: Astro.url.toString(),
    itemListElement: wordResults.slice(0, 50).map((word, index) => ({
        "@type": "ListItem",
        position: index + 1,
        url: new URL(`/words/${wordId(word)}`, Astro.url).toString(),
        item: {
            "@type": "Article",
            headline: word.title,
            datePublished: word.date.toISOString(),
            author: "L",
            keywords: word.tags,
        },
    })),
};

const wordsBreadcrumbs = {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    itemListElement: [
        {
            "@type": "ListItem",
            position: 1,
            name: "Home",
            item: new URL("/", Astro.url).toString(),
        },
        {
            "@type": "ListItem",
            position: 2,
            name: "Words",
            item: Astro.url.toString(),
        },
    ],
};
---

<Layout
    header="Words"
    title="Words"
    description="Words created by the LaTeX 4000 Collective"
>
    <script
        is:inline
        type="application/ld+json"
        set:html={JSON.stringify(wordsSchema)}
    />
    <script
        is:inline
        type="application/ld+json"
        set:html={JSON.stringify(wordsBreadcrumbs)}
    />
    {
        wordResults.length > 0 ? (
            <ul>
                {wordResults.map((word) => {
                    return (
                        <li
                            title={word.memberColor ?? "ANON"}
                            style={`--marker-color: ${word.memberColor ?? "inherit"}`}
                        >
                            <a href={`/words/${wordId(word)}`}>
                                {word.title}
                                <br />
                                {word.date.toLocaleString()}
                            </a>
                        </li>
                    );
                })}
            </ul>
        ) : (
            <p role="status">No words currently</p>
        )
    }
</Layout>

<style>
    li {
        margin-top: calc(var(--line-height) / 2);
    }

    li a {
        text-decoration: none;
    }

    li::marker {
        color: var(--marker-color);
    }
</style>
