---
import { and, eq } from "drizzle-orm";
import Layout from "../../layouts/Layout.astro";
import { readFile } from "fs/promises";
import { serverHTMLPurify } from "../../components/DOMPurify/server";
import db, { wordId } from "../../database/db";
import { Member, Word } from "../../database/schema";

export const prerender = false;

if (!process.env.WORDS_UPLOAD_DIRECTORY) {
    return new Response("WORDS_UPLOAD_DIRECTORY not set", { status: 500 });
}

const date = new Date(Number.parseInt(Astro.params.timestamp!, 10) * 1000);

if (Number.isNaN(date.getTime())) {
    return new Response(null, { status: 404 });
}

const wordResult = await db
    .select({
        word: Word,
        memberColor: Member.color,
    })
    .from(Word)
    .innerJoin(Member, eq(Word.memberDiscord, Member.discord))
    .where(and(eq(Word.date, date), eq(Word.deleted, false)))
    .get();

if (wordResult == null) {
    return new Response(null, { status: 404 });
}

const { memberColor, word } = wordResult;
const shownColour = word.showColour ? memberColor : "inherit";
const wordHtml = await readFile(
    `${process.env.WORDS_UPLOAD_DIRECTORY}/${wordId(word)}/words.html`,
    "utf8"
);

const purifiedHtml = await serverHTMLPurify(wordHtml, ".word-markdown");
const toPlainText = (html: string) =>
    html
        .replace(/<[^>]+>/g, " ")
        .replace(/\s+/g, " ")
        .trim();
const plainText = toPlainText(purifiedHtml);
const summary = plainText.slice(0, 160);
const canonicalUrl = Astro.url.toString();
const firstImageMatch = purifiedHtml.match(/<img[^>]*src="([^"]+)"/i);
const ogImage = firstImageMatch
    ? new URL(firstImageMatch[1]!, Astro.url).toString()
    : undefined;

const wordSchema = {
    "@context": "https://schema.org",
    "@type": "Article",
    headline: word.title,
    author: "L",
    datePublished: word.date.toISOString(),
    url: canonicalUrl,
    inLanguage: "en",
    keywords: word.tags,
    mainEntityOfPage: canonicalUrl,
    ...(ogImage ? { image: ogImage } : {}),
    ...(plainText ? { articleBody: plainText } : {}),
    ...(summary ? { description: summary } : {}),
    speakable: {
        "@type": "SpeakableSpecification",
        cssSelector: [".word-markdown"],
    },
};

const wordBreadcrumbs = {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    itemListElement: [
        {
            "@type": "ListItem",
            position: 1,
            name: "Home",
            item: new URL("/", Astro.url).toString(),
        },
        {
            "@type": "ListItem",
            position: 2,
            name: "Words",
            item: new URL("/words", Astro.url).toString(),
        },
        {
            "@type": "ListItem",
            position: 3,
            name: word.title,
            item: canonicalUrl,
        },
    ],
};
---

<Layout
    title={word.title}
    description={summary || word.title}
    colour={shownColour}
    ogType="article"
    ogImage={ogImage}
>
    <script
        is:inline
        type="application/ld+json"
        set:html={JSON.stringify(wordSchema)}
    />
    <script
        is:inline
        type="application/ld+json"
        set:html={JSON.stringify(wordBreadcrumbs)}
    />
    <small style={{ color: shownColour }}>{word.date.toLocaleString()}</small>
    <div class="word-markdown" set:html={purifiedHtml} />
    <p style={{ color: shownColour }}>-L</p>
    <div class="tags">
        {word.tags.map((tag) => <small>{tag}</small>)}
    </div>
</Layout>

<script>
    import { getDataUrl } from "../../data/emoji";

    document.addEventListener("DOMContentLoaded", async () => {
        const imgSrcPairs: [HTMLImageElement, string][] = [];

        for (const img of document.querySelectorAll(
            ".word-markdown img.emoji"
            // eslint-disable-next-line no-undef
        ) as NodeListOf<HTMLImageElement>) {
            imgSrcPairs.push([img, await getDataUrl(img.title.slice(1, -1))]);
        }

        for (const [img, src] of imgSrcPairs) {
            img.src = src;
        }
    });
</script>

<style is:global>
    .word-markdown img {
        display: initial;
    }

    .word-markdown .emoji {
        object-fit: contain;
        width: 1lh;
        height: 1lh;
        vertical-align: bottom;
    }
</style>

<style>
    .tags {
        display: flex;
        gap: var(--line-height);
        margin: var(--line-height) 0;
    }
</style>
