---
import Layout from "../layouts/Layout.astro";
import db from "../database/db";
import {
    Action,
    ActionItem,
    Member,
    Motion,
    Sight,
    Sound,
    Word,
} from "../database/schema";
import { and, desc, eq } from "drizzle-orm";
import { detectFeedType, linkChanger } from "../server/rss";
import type { FeedType } from "../server/rss";
import { thingColourHandler } from "../server/thingUtils";

export const prerender = false;

function rotateArray<T>(array: readonly T[]): T[] {
    const startIndex = Math.round(Math.random() * array.length);
    return [...array.slice(startIndex), ...array.slice(0, startIndex)];
}

const PER_TYPE_LIMIT = 15;
const HOME_SITE_LIMIT = 15;
const HOME_EXTERNAL_LIMIT = 10;
const COLLECTIVE_QUERY_LIMIT = HOME_EXTERNAL_LIMIT * 10;
const ALLOWED_FEED_TYPES = new Set<FeedType>([
    "soundcloud",
    "youtube",
    "bearblog",
    "other",
]);

function toPlainText(html: string): string {
    return html
        .replace(/<[^>]*>/g, " ")
        .replace(/\s+/g, " ")
        .trim();
}

function summarize(text: string, maxLength = 140): string | undefined {
    if (!text) return undefined;
    if (text.length <= maxLength) return text;
    return `${text.slice(0, maxLength - 3).trimEnd()}...`;
}

function slug(slugType: string, id: number, title: string): string {
    return `/${slugType}/${id}-${title.toLowerCase().replaceAll(/[\s_-]+/g, "-")}`;
}

type SiteFeedItem = {
    type: "sound" | "motion" | "sight" | "word";
    label: string;
    title: string;
    url: string;
    memberColor?: string;
    date: Date;
};

type ExternalFeedItem = {
    title: string;
    url: string;
    memberAlias: string;
    date: Date;
    summary?: string;
    sourceTitle: string;
    feedType: string;
};

const [memberRows, soundRows, motionRows, sightRows, wordRows, actionItemRows] =
    await Promise.all([
        db
            .select({
                addedRingToSite: Member.addedRingToSite,
                site: Member.site,
                alias: Member.alias,
            })
            .from(Member)
            .where(eq(Member.deleted, false)),
        db
            .select({
                id: Sound.id,
                title: Sound.title,
                date: Sound.date,
                memberColor: Member.color,
                showColour: Sound.showColour,
            })
            .from(Sound)
            .innerJoin(Member, eq(Sound.memberDiscord, Member.discord))
            .where(and(eq(Sound.deleted, false), eq(Member.deleted, false)))
            .orderBy(desc(Sound.date))
            .limit(PER_TYPE_LIMIT)
            .then(thingColourHandler),
        db
            .select({
                id: Motion.id,
                title: Motion.title,
                date: Motion.date,
                memberColor: Member.color,
                showColour: Motion.showColour,
            })
            .from(Motion)
            .innerJoin(Member, eq(Motion.memberDiscord, Member.discord))
            .where(and(eq(Motion.deleted, false), eq(Member.deleted, false)))
            .orderBy(desc(Motion.date))
            .limit(PER_TYPE_LIMIT)
            .then(thingColourHandler),
        db
            .select({
                id: Sight.id,
                title: Sight.title,
                description: Sight.description,
                date: Sight.date,
                memberColor: Member.color,
                showColour: Sight.showColour,
            })
            .from(Sight)
            .innerJoin(Member, eq(Sight.memberDiscord, Member.discord))
            .where(and(eq(Sight.deleted, false), eq(Member.deleted, false)))
            .orderBy(desc(Sight.date))
            .limit(PER_TYPE_LIMIT)
            .then(thingColourHandler),
        db
            .select({
                id: Word.id,
                title: Word.title,
                date: Word.date,
                memberColor: Member.color,
                showColour: Word.showColour,
            })
            .from(Word)
            .innerJoin(Member, eq(Word.memberDiscord, Member.discord))
            .where(and(eq(Word.deleted, false), eq(Member.deleted, false)))
            .orderBy(desc(Word.date))
            .limit(PER_TYPE_LIMIT)
            .then(thingColourHandler),
        db
            .select({
                id: ActionItem.id,
                title: ActionItem.title,
                description: ActionItem.description,
                url: ActionItem.url,
                date: ActionItem.date,
                actionTitle: Action.title,
                actionUrl: Action.url,
                memberAlias: Member.alias,
            })
            .from(ActionItem)
            .innerJoin(Action, eq(ActionItem.actionID, Action.id))
            .innerJoin(Member, eq(Action.memberDiscord, Member.discord))
            .where(and(eq(Action.deleted, false), eq(Member.deleted, false)))
            .orderBy(desc(ActionItem.date))
            .limit(COLLECTIVE_QUERY_LIMIT),
    ]);

const members = rotateArray(memberRows);

const thingToFeedItem = <
    T extends { id: number; title: string; date: Date; memberColor?: string },
>(
    rows: T[],
    type: SiteFeedItem["type"],
    label: string,
    // eslint-disable-next-line no-unused-vars
    urlFn: (row: T) => string
): SiteFeedItem[] => {
    return rows.map(
        (row): SiteFeedItem => ({
            type,
            label,
            title: row.title,
            url: urlFn(row),
            date: row.date,
            ...(row.memberColor ? { memberColor: row.memberColor } : {}),
        })
    );
};

const rawSiteFeed: SiteFeedItem[] = [
    ...thingToFeedItem(soundRows, "sound", "Sound", (row) =>
        slug("sounds", row.id, row.title)
    ),
    ...thingToFeedItem(motionRows, "motion", "Motion", (row) =>
        slug("motions", row.id, row.title)
    ),
    ...thingToFeedItem(sightRows, "sight", "Sight", (row) =>
        slug("sights", row.id, row.title)
    ),
    ...thingToFeedItem(
        wordRows,
        "word",
        "Word",
        (row) => `/words/${Math.floor(row.date.getTime() / 1000).toString(10)}`
    ),
];

const siteFeed = rawSiteFeed
    .sort((a, b) => b.date.getTime() - a.date.getTime())
    .slice(0, HOME_SITE_LIMIT);

const rawCollectiveFeed: ExternalFeedItem[] = actionItemRows.flatMap((item) => {
    const feedType = detectFeedType(item.actionUrl);
    if (!ALLOWED_FEED_TYPES.has(feedType)) return [];

    const processedTitle = item.title ?? item.actionTitle;
    const plainDescription = summarize(toPlainText(item.description));
    const summary =
        plainDescription && plainDescription !== processedTitle
            ? plainDescription
            : undefined;

    return [
        {
            title: processedTitle,
            url: linkChanger(item.url, feedType),
            memberAlias: item.memberAlias,
            date: item.date,
            ...(summary ? { summary } : {}),
            sourceTitle: item.actionTitle,
            feedType,
        } satisfies ExternalFeedItem,
    ];
});

const collectiveFeed = rawCollectiveFeed
    .sort((a, b) => b.date.getTime() - a.date.getTime())
    .slice(0, HOME_EXTERNAL_LIMIT);
---

<Layout header="Yo">
    <p>
        We're a group of friends who have just been doing various shit, spanning
        from visual arts, music, games, computer science, and more
    </p>
    <p>
        What first started as a skype group between friends playing <a
            href="https://osu.ppy.sh/">osu!</a
        > then became a discord server's channel created on <time
            datetime="2015-09-15">September 13 2015</time
        ><br />We then moved into our own server at some point between <time
            datetime="2016">March-May 2016</time
        ><br />That server was unfortunately spontaneously deleted, but then
        recreated on the same day, <time datetime="2017-04-22"
            >April 22 2017</time
        >
    </p>
    <p>
        We made this site on <time datetime="2025-01-05">January 5 2025</time> to
        be able to collectively output anything we wanted publicly + anonymously,
        and to create a public facing webring collective<br />We've been chillin
        since then
    </p>
    <p>
        On this site, you can find anyone from the group who has connected their
        website and socials to the webring, as well as a musical project we
        created to submit and upload tracks we don't want to upload on our own
        aliases
    </p>
    <p>Enjoy your stay</p>

    <div>
        Signed:
        <ul>
            {
                members.map((member) => (
                    <li>
                        {member.addedRingToSite ? (
                            <a href={member.site}>{member.alias}</a>
                        ) : (
                            member.alias
                        )}
                    </li>
                ))
            }
        </ul>
    </div>

    <div>
        <h2>Latest activity</h2>
        <div class="home-feed__columns">
            <div class="feed-column">
                <h3>Latest on the site</h3>
                {
                    siteFeed.length > 0 ? (
                        <ul class="feed-list">
                            {siteFeed.map((item) => (
                                <li class="feed-item">
                                    <span class="feed-item__header">
                                        {item.label}
                                    </span>
                                    <time datetime={item.date.toISOString()}>
                                        {item.date.toLocaleString()}
                                    </time>
                                    <a class="feed-item__title" href={item.url}>
                                        {item.title}
                                    </a>
                                    <div
                                        class="feed-item__byline"
                                        style={
                                            item.memberColor
                                                ? `color: ${item.memberColor}`
                                                : undefined
                                        }
                                        aria-label={item.memberColor ?? "ANON"}
                                        title={item.memberColor ?? "ANON"}
                                    >
                                        L
                                    </div>
                                </li>
                            ))}
                        </ul>
                    ) : (
                        <p>No recent site updates.</p>
                    )
                }
            </div>
            <div
                class="feed-column"
                data-collective={JSON.stringify(collectiveFeed)}
            >
                <h3>Latest from the collective</h3>
                {
                    collectiveFeed.length > 0 ? (
                        <ul class="feed-list">
                            {collectiveFeed.map((item) => (
                                <li class="feed-item">
                                    <span class="feed-item__header">
                                        {item.feedType}
                                    </span>
                                    <time datetime={item.date.toISOString()}>
                                        {item.date.toLocaleString()}
                                    </time>
                                    <a
                                        class="feed-item__title"
                                        href={item.url}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                    >
                                        {item.title}
                                    </a>
                                    <div
                                        class="feed-item__byline"
                                        aria-label="member alias"
                                    >
                                        by {item.memberAlias}
                                    </div>
                                    {item.summary ? (
                                        <p class="feed-item__summary">
                                            {item.summary}
                                        </p>
                                    ) : undefined}
                                </li>
                            ))}
                        </ul>
                    ) : (
                        <p>No recent collective updates.</p>
                    )
                }
            </div>
        </div>
    </div>
</Layout>

<style>
    ul {
        margin-top: var(--home-grid-margin-block-start, 0.5lh);
        padding: 0;
        display: grid;
        width: 100%;
        grid-template-columns: repeat(2, 1fr);
        column-gap: var(--space-inline-sm);
        row-gap: var(--home-grid-row-gap, 0);
        width: var(--home-grid-width, 100%);
    }

    @media (min-width: 500px) {
        ul {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (min-width: 600px) {
        ul {
            grid-template-columns: repeat(4, 1fr);
        }
    }

    @media (min-width: 700px) {
        ul {
            grid-template-columns: repeat(5, 1fr);
        }
    }

    li {
        white-space: nowrap;
        list-style-position: inside;
    }

    li::marker {
        white-space: nowrap;
    }

    .home-feed__columns {
        display: grid;
        gap: var(--space-lg, 2lh);
    }

    @media (min-width: 720px) {
        .home-feed__columns {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }

    .feed-column {
        display: flex;
        flex-direction: column;
        gap: var(--space-sm, 1lh);
    }

    .feed-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: var(--space-sm, 1lh);
    }

    .feed-item {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs, 0.5lh);
        overflow: hidden;
        text-overflow: ellipsis;
        padding: var(--space-sm, 1lh);
        border: var(--border-thickness, 1px) solid
            var(--text-color, currentColor);
    }

    .feed-item__header {
        font-weight: 600;
        text-transform: uppercase;
    }

    .feed-item__title {
        font-weight: 600;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .feed-item__summary {
        margin: 0;
        font-size: 0.75em;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .feed-item time {
        white-space: nowrap;
    }

    .members-section {
        margin-top: var(--space-lg, 2lh);
    }
</style>
