---
import { desc, eq, getTableColumns } from "drizzle-orm";
import Layout from "../layouts/Layout.astro";
import {
    AudioPlayer,
    MasterAudioPlayer,
} from "../components/Sounds/AudioPlayer";
import db from "../database/db";
import { Member, Sound } from "../database/schema";
import { thingColourHandler } from "../server/thingUtils";

export const prerender = false;

const sounds = await db
    .select({
        ...getTableColumns(Sound),
        memberColor: Member.color,
    })
    .from(Sound)
    .where(eq(Sound.deleted, false))
    .innerJoin(Member, eq(Sound.memberDiscord, Member.discord))
    .orderBy(desc(Sound.id))
    .then(thingColourHandler);

const toSlug = (value: string) =>
    value.toLowerCase().replaceAll(/[\s_-]+/g, "-");
const makeSoundUrl = (soundId: number, title: string) =>
    new URL(`/sounds/${soundId}-${toSlug(title)}`, Astro.url).toString();
const soundsSchema = {
    "@context": "https://schema.org",
    "@type": "ItemList",
    name: "LaTeX 4000 Sounds",
    url: Astro.url.toString(),
    itemListElement: sounds.slice(0, 25).map((sound, index) => {
        const coverUrl = new URL(
            `/sounds-uploads/${sound.id}/cover.${sound.coverType}`,
            Astro.url
        ).toString();
        const trackUrl = new URL(
            `/sounds-uploads/${sound.id}/track.${sound.trackType}`,
            Astro.url
        ).toString();
        const sameAs = [sound.youtubeUrl, sound.soundcloudUrl].filter(
            (value): value is string => typeof value === "string"
        );
        const trackMimeType =
            sound.trackType === "mp3" ? "audio/mpeg" : "audio/wav";

        return {
            "@type": "ListItem",
            position: index + 1,
            url: makeSoundUrl(sound.id, sound.title),
            item: {
                "@type": "MusicRecording",
                name: sound.title,
                datePublished: sound.date.toISOString(),
                image: coverUrl,
                sameAs,
                byArtist: {
                    "@type": "MusicGroup",
                    name: "L",
                },
                recordingOf: {
                    "@type": "MusicComposition",
                    name: sound.title,
                    keywords: sound.tags,
                },
                audio: {
                    "@type": "AudioObject",
                    contentUrl: trackUrl,
                    encodingFormat: trackMimeType,
                },
                genre: sound.tags,
            },
        };
    }),
};

const soundsBreadcrumbs = {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    itemListElement: [
        {
            "@type": "ListItem",
            position: 1,
            name: "Home",
            item: new URL("/", Astro.url).toString(),
        },
        {
            "@type": "ListItem",
            position: 2,
            name: "Sounds",
            item: Astro.url.toString(),
        },
    ],
};

const activeSoundId =
    typeof Astro.locals.soundId === "number" ? Astro.locals.soundId : undefined;
const activeSound =
    activeSoundId != null
        ? sounds.find((sound) => sound.id === activeSoundId)
        : undefined;

const activeSoundSchema = activeSound
    ? {
          "@context": "https://schema.org",
          "@type": "MusicRecording",
          name: activeSound.title,
          byArtist: {
              "@type": "MusicGroup",
              name: "L",
          },
          datePublished: activeSound.date.toISOString(),
          url: makeSoundUrl(activeSound.id, activeSound.title),
          image: new URL(
              `/sounds-uploads/${activeSound.id}/cover.${activeSound.coverType}`,
              Astro.url
          ).toString(),
          keywords: activeSound.tags,
          sameAs: [activeSound.youtubeUrl, activeSound.soundcloudUrl].filter(
              (value): value is string => typeof value === "string"
          ),
          recordingOf: {
              "@type": "MusicComposition",
              name: activeSound.title,
              keywords: activeSound.tags,
          },
          audio: {
              "@type": "AudioObject",
              contentUrl: new URL(
                  `/sounds-uploads/${activeSound.id}/track.${activeSound.trackType}`,
                  Astro.url
              ).toString(),
              encodingFormat:
                  activeSound.trackType === "mp3" ? "audio/mpeg" : "audio/wav",
          },
          genre: activeSound.tags,
      }
    : undefined;

const soundsOgImage = sounds[0]
    ? new URL(
          `/sounds-uploads/${sounds[0]!.id}/cover.${sounds[0]!.coverType}`,
          Astro.url
      ).toString()
    : undefined;
---

<Layout
    header="Sounds"
    title="Sounds"
    description="Sounds created by the LaTeX 4000 Collective"
    ogImage={soundsOgImage}
    ogType="music.playlist"
>
    <script
        is:inline
        type="application/ld+json"
        set:html={JSON.stringify(soundsSchema)}
    />
    <script
        is:inline
        type="application/ld+json"
        set:html={JSON.stringify(soundsBreadcrumbs)}
    />
    {
        activeSoundSchema ? (
            <script
                is:inline
                type="application/ld+json"
                set:html={JSON.stringify(activeSoundSchema)}
            />
        ) : undefined
    }
    A lot of us in the group make music. We have released about {sounds.length} sounds
    so far under the LaTeX 4000 name instead of our own:
    <div class="sounds">
        {
            sounds.map((sound) => (
                <div class="sound" data-sound-id={sound.id}>
                    <img
                        alt={`Cover art for ${sound.title}`}
                        src={`/sounds-uploads/${sound.id}/cover.${sound.coverType}`}
                        loading="lazy"
                        decoding="async"
                        style={{
                            border: sound.memberColor
                                ? `var(--border-thickness) solid ${sound.memberColor}`
                                : "none",
                        }}
                    />
                    <div class="details">
                        <h2>
                            <a
                                href={`/sounds/${sound.id}-${toSlug(sound.title)}`}
                            >
                                {sound.title}
                            </a>
                        </h2>
                        {/* prettier-ignore */}
                        <div>
                            {sound.youtubeUrl != null && (
                                <>
                                    <a href={sound.youtubeUrl}>{/* prettier-ignore */}<span class="y">You</span><span class="t">Tube</span></a>
                                    |
                                </>
                            )}
                            {sound.soundcloudUrl != null && (
                                <>
                                    <a href={sound.soundcloudUrl}>{/* prettier-ignore */}<span class="s">Sound</span><span class="c">Cloud</span></a>
                                    |
                                </>
                            )}
                            <time class="sound-date" datetime={sound.date.toISOString()}>
                                {sound.date.toUTCString()}
                            </time>
                        </div>
                        <div class="audio-player-container">
                            <AudioPlayer
                                client:only="react"
                                src={`/sounds-uploads/${sound.id}/track.${sound.trackType}`}
                                title={sound.title}
                                trackType={sound.trackType}
                                coverUrl={new URL(
                                    `/sounds-uploads/${sound.id}/cover.${sound.coverType}`,
                                    Astro.url
                                ).toString()}
                                id={sound.id}
                            />
                        </div>
                        <div class="tags">
                            {sound.tags.map((tag) => (
                                <span data-tag={tag}>{tag}</span>
                            ))}
                        </div>
                    </div>
                </div>
            ))
        }
    </div>

    <MasterAudioPlayer client:only="react" />
</Layout>

<script is:inline define:vars={{ soundId: Astro.locals.soundId }}>
    const formatDate = (isoString) => {
        const date = new Date(isoString);
        if (Number.isNaN(date.getTime())) return null;

        return date.toLocaleString(navigator.language || "en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        });
    };

    document.querySelectorAll("time.sound-date").forEach((timeEl) => {
        const iso = timeEl.getAttribute("datetime");
        const formatted = iso ? formatDate(iso) : null;

        if (formatted) timeEl.textContent = formatted;
    });

    if (soundId != null) {
        // Overriding scroll restoration to prevent the browser from fuckinf with scroll position when we try to scroll to the sound.
        const previous = history.scrollRestoration;
        history.scrollRestoration = "manual";

        const performScroll = () => {
            document
                .querySelector(`.sound[data-sound-id="${soundId}"]`)
                ?.scrollIntoView();
            history.scrollRestoration = previous;
        };

        window.addEventListener(
            "load",
            () => requestAnimationFrame(performScroll),
            { once: true }
        );
    }
</script>

<style>
    body {
        margin-bottom: calc(var(--space-lg) * 2) !important;
    }

    .sounds {
        margin: var(--space-sm) 0;
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
    }

    .sound {
        display: flex;
        gap: var(--space-inline-md);
        flex: 0 0 var(--media-cover-size-lg, 11lh);
        flex: 0 0 round(var(--media-cover-size-lg, 11lh), 1ch);
    }

    .sound img {
        width: var(--media-cover-size-lg, 11lh);
        height: var(--media-cover-size-lg, 11lh);
        flex: none;
        object-fit: cover;
    }

    @media (max-width: 800px) {
        .sound img {
            width: var(--media-cover-size-md, 8lh);
            height: var(--media-cover-size-md, 8lh);
        }
    }

    @media (max-width: 600px) {
        .sound img {
            width: var(--media-cover-size-sm, 5lh);
            height: var(--media-cover-size-sm, 5lh);
        }
    }

    @media (max-width: 400px) {
        .sound img {
            width: var(--media-cover-size-xs, 3lh);
            height: var(--media-cover-size-xs, 3lh);
        }
    }

    .details {
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
        flex-grow: 1;
        min-width: 0;
    }

    h2 {
        height: var(--space-lg);
        margin: 0;
        text-transform: none;
    }

    h2 > a {
        color: inherit;
        text-decoration: none;
    }

    .tags {
        display: flex;
        gap: var(--space-inline-md);
        overflow-x: auto;
        margin-top: auto;
    }

    .tags > span {
        border: var(--border-thickness) solid var(--text-color);
        padding: calc(var(--space-xs) - var(--border-thickness))
            calc(var(--space-inline-md) - var(--border-thickness));
        text-wrap: nowrap;
    }

    .y {
        color: var(--text-color-alt);
    }

    .t {
        color: rgb(255, 0, 0);
    }

    .s {
        color: rgb(255, 85, 0);
    }

    .c {
        color: rgb(255, 115, 0);
    }
</style>
