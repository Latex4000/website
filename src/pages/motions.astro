---
import { desc, eq, getTableColumns } from "drizzle-orm";
import db from "../database/db";
import { Member, Motion } from "../database/schema";
import Layout from "../layouts/Layout.astro";
import { thingColourHandler } from "../server/thingUtils";

export const prerender = false;

const toSlug = (value: string) =>
    value.toLowerCase().replaceAll(/[\s_-]+/g, "-");

const toEmbedUrl = (url: string): string => {
    try {
        const parsed = new URL(url);
        if (parsed.hostname === "youtu.be") {
            const id = parsed.pathname.slice(1);
            if (id) return `https://www.youtube.com/embed/${id}`;
        }

        if (parsed.hostname.includes("youtube")) {
            const id = parsed.searchParams.get("v");
            if (id) return `https://www.youtube.com/embed/${id}`;
        }
    } catch (error) {
        console.warn("[motions] Failed to build embed URL", error);
    }

    return url.replace(/watch\?v=/, "embed/");
};

const toThumbnailUrl = (url: string): string | undefined => {
    try {
        const parsed = new URL(url);
        if (parsed.hostname === "youtu.be") {
            const id = parsed.pathname.slice(1);
            return id
                ? `https://img.youtube.com/vi/${id}/hqdefault.jpg`
                : undefined;
        }

        if (parsed.hostname.includes("youtube")) {
            const id = parsed.searchParams.get("v");
            return id
                ? `https://img.youtube.com/vi/${id}/hqdefault.jpg`
                : undefined;
        }
    } catch (error) {
        console.warn("[motions] Failed to build thumbnail URL", error);
    }

    return undefined;
};

const motions = await db
    .select({
        ...getTableColumns(Motion),
        memberColor: Member.color,
    })
    .from(Motion)
    .where(eq(Motion.deleted, false))
    .innerJoin(Member, eq(Motion.memberDiscord, Member.discord))
    .orderBy(desc(Motion.id))
    .then(thingColourHandler);

const motionsSchema = {
    "@context": "https://schema.org",
    "@type": "ItemList",
    name: "Motions",
    url: Astro.url.toString(),
    itemListElement: motions.slice(0, 25).map((motion, index) => {
        const pageUrl = new URL(
            `/motions/${motion.id}-${toSlug(motion.title)}`,
            Astro.url
        ).toString();
        const embedUrl = toEmbedUrl(motion.youtubeUrl);
        const thumbnailUrl = toThumbnailUrl(motion.youtubeUrl);

        return {
            "@type": "ListItem",
            position: index + 1,
            url: pageUrl,
            item: {
                "@type": "VideoObject",
                name: motion.title,
                description: `Video created by the LaTeX 4000 Collective`,
                uploadDate: motion.date.toISOString(),
                url: pageUrl,
                embedUrl,
                publisher: {
                    "@type": "Organization",
                    name: "LaTeX 4000",
                    url: new URL("/", Astro.url).toString(),
                },
                creator: {
                    "@type": "Person",
                    name: "L",
                },
                ...(thumbnailUrl ? { thumbnailUrl } : {}),
                keywords: motion.tags,
                sameAs: motion.youtubeUrl ? [motion.youtubeUrl] : undefined,
            },
        };
    }),
};

const motionsBreadcrumbs = {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    itemListElement: [
        {
            "@type": "ListItem",
            position: 1,
            name: "Home",
            item: new URL("/", Astro.url).toString(),
        },
        {
            "@type": "ListItem",
            position: 2,
            name: "Motions",
            item: Astro.url.toString(),
        },
    ],
};

const activeMotionId =
    typeof Astro.locals.motionId === "number"
        ? Astro.locals.motionId
        : undefined;
const activeMotion =
    activeMotionId != null
        ? motions.find((motion) => motion.id === activeMotionId)
        : undefined;

const activeMotionSchema = activeMotion
    ? {
          "@context": "https://schema.org",
          "@type": "VideoObject",
          name: activeMotion.title,
          description: `Video created by the LaTeX 4000 Collective`,
          uploadDate: activeMotion.date.toISOString(),
          url: new URL(
              `/motions/${activeMotion.id}-${toSlug(activeMotion.title)}`,
              Astro.url
          ).toString(),
          embedUrl: toEmbedUrl(activeMotion.youtubeUrl),
          creator: {
              "@type": "Person",
              name: "L",
          },
          publisher: {
              "@type": "Organization",
              name: "LaTeX 4000",
              url: new URL("/", Astro.url).toString(),
          },
          ...(() => {
              const thumbnailUrl = toThumbnailUrl(activeMotion.youtubeUrl);
              return thumbnailUrl ? { thumbnailUrl } : {};
          })(),
          keywords: activeMotion.tags,
          sameAs: activeMotion.youtubeUrl
              ? [activeMotion.youtubeUrl]
              : undefined,
      }
    : undefined;

const motionsOgImage = (() => {
    for (const motion of motions) {
        const thumbnailUrl = toThumbnailUrl(motion.youtubeUrl);
        if (thumbnailUrl) return thumbnailUrl;
    }
    return undefined;
})();
---

<Layout
    header="Motions"
    title="Motions"
    description="Motions created by the LaTeX 4000 Collective"
    ogImage={motionsOgImage}
    ogType="video.other"
>
    <script
        is:inline
        type="application/ld+json"
        set:html={JSON.stringify(motionsSchema)}
    />
    <script
        is:inline
        type="application/ld+json"
        set:html={JSON.stringify(motionsBreadcrumbs)}
    />
    {
        activeMotionSchema ? (
            <script
                is:inline
                type="application/ld+json"
                set:html={JSON.stringify(activeMotionSchema)}
            />
        ) : undefined
    }
    Some of us are REALLY bored. Here are {motions.length} motions that we have released
    under the collective's name instead of our own:
    <div class="motions" role="list" aria-label="Motions list">
        {
            motions.map((motion) => (
                <article
                    class="motion"
                    data-motion-id={motion.id}
                    role="listitem"
                    aria-labelledby={`motion-title-${motion.id}`}
                    aria-describedby={`motion-meta-${motion.id}`}
                >
                    <iframe
                        src={toEmbedUrl(motion.youtubeUrl)}
                        style={{
                            width: "var(--media-video-width, 16lh)",
                            height: "var(--media-video-height, 9lh)",
                            border: motion.memberColor
                                ? `var(--border-thickness) solid ${motion.memberColor}`
                                : "none",
                        }}
                        title={`${motion.title} video`}
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        referrerpolicy="strict-origin-when-cross-origin"
                        allowfullscreen
                        loading="lazy"
                    />
                    <div class="details">
                        <h2 id={`motion-title-${motion.id}`}>
                            <a
                                href={`/motions/${motion.id}-${toSlug(motion.title)}`}
                            >
                                {motion.title}
                            </a>
                        </h2>
                        {/* prettier-ignore */}
                        <div id={`motion-meta-${motion.id}`}>
                            <a href={motion.youtubeUrl}>{/* prettier-ignore */}<span class="y">You</span><span class="t">Tube</span></a>
                            |
                            <span>{motion.date.toLocaleString()}</span>
                        </div>
                        <div class="tags">
                            {motion.tags.map((tag) => (
                                <span>{tag}</span>
                            ))}
                        </div>
                    </div>
                </article>
            ))
        }
    </div>
</Layout>

<script is:inline define:vars={{ motionId: Astro.locals.motionId }}>
    if (motionId != null) {
        document
            .querySelector(`.motion[data-motion-id="${motionId}"]`)
            ?.scrollIntoView();
    }
</script>

<style>
    /* This is straightup copypasted and barely edited from sounds.astro... probably should just make a component that works for both */
    .motions {
        margin: var(--space-sm) 0;
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
    }

    .motion {
        display: flex;
        gap: var(--space-inline-md);
        flex: 0 0 var(--media-cover-size-lg, 11lh);
        flex: 0 0 round(var(--media-cover-size-lg, 11lh), 1ch);
        line-height: 1;
        scroll-margin-top: var(--space-lg, 2lh);
    }

    .details {
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
        flex-grow: 1;
        min-width: 0;
    }

    h2 {
        height: var(--space-lg);
        margin: 0;
        text-transform: none;
    }

    .tags {
        display: flex;
        gap: var(--space-inline-md);
        overflow-x: auto;
    }

    .tags > span {
        border: var(--border-thickness) solid var(--text-color);
        padding: calc(var(--space-xs) - var(--border-thickness))
            calc(var(--space-inline-md) - var(--border-thickness));
        text-wrap: nowrap;
    }

    .y {
        color: var(--text-color-alt);
    }

    .t {
        color: rgb(255, 0, 0);
    }
</style>
