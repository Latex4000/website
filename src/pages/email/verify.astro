---
import Layout from "../../layouts/Layout.astro";
import db, { retryIfDbBusy } from "../../database/db";
import { Subscriber } from "../../database/schema";
import { eq } from "drizzle-orm";

export const prerender = false;

type Status = "missing" | "invalid" | "already" | "success";

const token = Astro.url.searchParams.get("token");
let status: Status = "missing";

if (!token) {
    status = "missing";
} else {
    try {
        const subscriber = await db
            .select()
            .from(Subscriber)
            .where(eq(Subscriber.verifyToken, token))
            .get();

        if (!subscriber) {
            status = "invalid";
        } else if (
            subscriber.verifiedAt !== null &&
            subscriber.unsubscribedAt === null
        ) {
            status = "already";
        } else {
            await retryIfDbBusy(() =>
                db
                    .update(Subscriber)
                    .set({
                        verifiedAt: new Date(),
                        unsubscribedAt: null,
                    })
                    .where(eq(Subscriber.id, subscriber.id))
            );

            status = "success";
        }
    } catch (error) {
        console.error("Failed to verify subscriber", error);
        status = "invalid";
    }
}
---

<Layout
    header="Email verification"
    title="Email verification"
    description="LaTeX 4000 email verification"
>
    {
        status === "missing" ? (
            <p>
                Verification token missing. Please use the link from your email.
            </p>
        ) : undefined
    }
    {
        status === "invalid" ? (
            <p>
                Invalid verification link. Request a new email update
                subscription.
            </p>
        ) : undefined
    }
    {
        status === "already" ? (
            <p>
                Welcome back. Your email is already verified. You will continue
                to receive updates based on your saved preferences.
            </p>
        ) : undefined
    }
    {
        status === "success" ? (
            <p>
                Yo, your email is now verified. Soon you will start receiving
                updates based on your saved preferences.
            </p>
        ) : undefined
    }
</Layout>
