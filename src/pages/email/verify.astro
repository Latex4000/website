---
import Layout from "../../layouts/Layout.astro";
import db, { retryIfDbBusy } from "../../database/db";
import { Subscriber } from "../../database/schema";
import { eq } from "drizzle-orm";
import { randomBytes } from "node:crypto";

type Status = "missing" | "invalid" | "already" | "success";

const token = Astro.url.searchParams.get("token");
let status: Status = "missing";

function createToken(): string {
    return randomBytes(24).toString("hex");
}

if (!token) {
    status = "missing";
} else {
    try {
        const subscriber = await db
            .select()
            .from(Subscriber)
            .where(eq(Subscriber.verifyToken, token))
            .get();

        if (!subscriber) {
            status = "invalid";
        } else if (
            subscriber.verifiedAt !== null &&
            subscriber.unsubscribedAt === null
        ) {
            status = "already";
        } else {
            await retryIfDbBusy(() =>
                db
                    .update(Subscriber)
                    .set({
                        verifyToken: createToken(),
                        verifiedAt: new Date(),
                        unsubscribedAt: null,
                    })
                    .where(eq(Subscriber.id, subscriber.id))
            );

            status = "success";
        }
    } catch (error) {
        console.error("Failed to verify subscriber", error);
        status = "invalid";
    }
}
---

<Layout
    header="Email verification"
    title="Email verification"
    description="LaTeX 4000 email verification"
>
    {
        status === "missing" ? (
            <p>
                Verification token missing. Please use the link from your email.
            </p>
        ) : undefined
    }
    {
        status === "invalid" ? (
            <p>
                That verification link is not valid. Request a new email update
                subscription.
            </p>
        ) : undefined
    }
    {
        status === "already" ? (
            <p>
                Your email is already verified. You will continue to receive
                updates based on your saved preferences.
            </p>
        ) : undefined
    }
    {
        status === "success" ? (
            <p>
                You're all set! Your email is verified and daily digests will
                start arriving when new content is published.
            </p>
        ) : undefined
    }
</Layout>
