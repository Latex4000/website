---
import Layout from "../layouts/Layout.astro";
import WatcherDashboard from "../components/Watcher/WatcherDashboard.svelte";
import {
    getContentCounts,
    getDailyViews,
    getLatestPageViews,
    getPageViewTotals,
    getStatusBreakdown,
    getTopPages,
    getTopReferrers,
    serializeDailyViews,
    serializeLatestPageViews,
    type PageViewFilters,
    type PaginationOptions,
    type WatcherApiResponse,
} from "../server/analytics";

export const prerender = false;

const defaultFilters: PageViewFilters = { includeEmptyPath: false };
const defaultPagination: Record<
    "topPages" | "latest" | "referrers" | "status",
    PaginationOptions
> = {
    topPages: { limit: 10, offset: 0 },
    latest: { limit: 20, offset: 0 },
    referrers: { limit: 10, offset: 0 },
    status: { limit: 10, offset: 0 },
};
const [
    totals,
    contentCounts,
    dailyViews,
    topPages,
    latestPageViews,
    topReferrers,
    statusBreakdown,
] = await Promise.all([
    getPageViewTotals(defaultFilters),
    getContentCounts(),
    getDailyViews(defaultFilters),
    getTopPages(defaultFilters, defaultPagination.topPages),
    getLatestPageViews(defaultFilters, defaultPagination.latest),
    getTopReferrers(defaultFilters, defaultPagination.referrers),
    getStatusBreakdown(defaultFilters, defaultPagination.status),
]);

const serializedDailyViews = serializeDailyViews(dailyViews);
const serializedLatestPageViews = serializeLatestPageViews(latestPageViews);

const initialPayload: WatcherApiResponse = {
    serverNow: new Date().toISOString(),
    filters: {
        from: null,
        to: null,
        pagePath: null,
        statusCodes: [],
        referrerQuery: null,
        includeEmptyPath: defaultFilters.includeEmptyPath ?? false,
        timezoneOffsetMinutes: null,
    },
    results: {
        totals,
        contentCounts,
        dailyViews: serializedDailyViews,
        topPages,
        latestPageViews: serializedLatestPageViews,
        topReferrers,
        statusBreakdown,
    },
    pagination: defaultPagination,
};
---

<Layout header="Watcher" title="Watcher" description="Let's Have A Watch">
    <section class="context">
        <details>
            <summary>What you are looking at</summary>
            <a class="watching" href="https://tenor.com/srIBhS4OjXr.gif">
                Lets have a watch <span class="massive_eyes">ðŸ‘€</span>
            </a>
            <p>
                This page shows view analytics from the database. Use the
                controls to slice by date range, status, referrer, or path. Data
                updates automatically when you change filters and includes
                content totals from the other catalog tables.
            </p>
            <p>
                The API driving this view lives in
                <a href="/api/analytics" rel="external" target="_blank"
                    >/api/analytics</a
                > and its functionality is primarily in
                <a
                    href="https://github.com/Latex4000/website/blob/main/src/server/analytics.ts"
                    rel="external"
                    target="_blank">src/server/analytics.ts</a
                >.
            </p>
        </details>
    </section>

    <WatcherDashboard client:load data={initialPayload} />
</Layout>

<style>
    .context {
        margin-bottom: 2lh;
    }

    .context summary:focus-visible {
        outline: 2px solid var(--text-color);
        outline-offset: 2px;
    }

    .watching {
        line-height: 1;
    }

    .massive_eyes {
        font-size: 20em;
        vertical-align: middle;
    }
</style>
