---
import { and, desc, eq, gt, ne, sql } from "drizzle-orm";
import Layout from "../layouts/Layout.astro";
import db from "../database/db";
import {
    PageView,
    Member,
    Action,
    Sound,
    Motion,
    Sight,
    Word,
} from "../database/schema";

export const prerender = false;

const now = Date.now();
const dayAgo = new Date(now - 24 * 60 * 60 * 1000);
const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);

const pageViewFilter = ne(PageView.path, "");

const [
    totalsRow,
    lastDayRow,
    lastWeekRow,
    topPagesOverall,
    topPagesWeek,
    latestPageViews,
] = await Promise.all([
    db
        .select({
            views: sql<number>`count(*)`,
        })
        .from(PageView)
        .where(pageViewFilter)
        .get(),
    db
        .select({
            views: sql<number>`count(*)`,
        })
        .from(PageView)
        .where(and(pageViewFilter, gt(PageView.createdAt, dayAgo)))
        .get(),
    db
        .select({
            views: sql<number>`count(*)`,
        })
        .from(PageView)
        .where(and(pageViewFilter, gt(PageView.createdAt, weekAgo)))
        .get(),
    db
        .select({
            path: PageView.path,
            views: sql<number>`count(*)`,
        })
        .from(PageView)
        .where(pageViewFilter)
        .groupBy(PageView.path)
        .orderBy(sql`count(*) DESC`)
        .limit(10),
    db
        .select({
            path: PageView.path,
            views: sql<number>`count(*)`,
        })
        .from(PageView)
        .where(and(pageViewFilter, gt(PageView.createdAt, weekAgo)))
        .groupBy(PageView.path)
        .orderBy(sql`count(*) DESC`)
        .limit(10),
    db
        .select({
            path: PageView.path,
            createdAt: PageView.createdAt,
            status: PageView.status,
            referrer: PageView.referrer,
        })
        .from(PageView)
        .where(pageViewFilter)
        .orderBy(desc(PageView.createdAt))
        .limit(20),
]);

const totals = {
    views: totalsRow?.views ?? 0,
    viewsDay: lastDayRow?.views ?? 0,
    viewsWeek: lastWeekRow?.views ?? 0,
};

const [membersRow, actionsRow, soundsRow, motionsRow, sightsRow, wordsRow] =
    await Promise.all([
        db
            .select({ count: sql<number>`count(*)` })
            .from(Member)
            .where(eq(Member.deleted, false))
            .get(),
        db
            .select({ count: sql<number>`count(*)` })
            .from(Action)
            .where(eq(Action.deleted, false))
            .get(),
        db
            .select({ count: sql<number>`count(*)` })
            .from(Sound)
            .where(eq(Sound.deleted, false))
            .get(),
        db
            .select({ count: sql<number>`count(*)` })
            .from(Motion)
            .where(eq(Motion.deleted, false))
            .get(),
        db
            .select({ count: sql<number>`count(*)` })
            .from(Sight)
            .where(eq(Sight.deleted, false))
            .get(),
        db
            .select({ count: sql<number>`count(*)` })
            .from(Word)
            .where(eq(Word.deleted, false))
            .get(),
    ]);

const contentTotals = {
    members: membersRow?.count ?? 0,
    actions: actionsRow?.count ?? 0,
    sounds: soundsRow?.count ?? 0,
    motions: motionsRow?.count ?? 0,
    sights: sightsRow?.count ?? 0,
    words: wordsRow?.count ?? 0,
};
---

<Layout header="Watcher" title="Watcher" description="Let's Have A Watch">
    <p>
        Analytics since ~Nov 8 UTC. For anyone interested you can see the code
        of how it works <a
            href="https://github.com/Latex4000/website/blob/main/src/server/analytics.ts"
            >here</a
        >.
    </p>
    {
        totals.views === 0 ? (
            <p>
                No page view data yet. Traffic will begin to appear here once
                the site receives requests.
            </p>
        ) : (
            <section class="summary">
                <div>
                    <h3>Total</h3>
                    <p>{totals.views.toLocaleString()} page views</p>
                </div>
                <div>
                    <h3>Last 7 days</h3>
                    <p>{totals.viewsWeek.toLocaleString()} page views</p>
                </div>
                <div>
                    <h3>Last 24 hours</h3>
                    <p>{totals.viewsDay.toLocaleString()} page views</p>
                </div>
            </section>
        )
    }

    {
        contentTotals.members +
            contentTotals.actions +
            contentTotals.sounds +
            contentTotals.motions +
            contentTotals.sights +
            contentTotals.words >
            0 && (
            <section>
                <h3>Content overview</h3>
                <div class="content-grid">
                    <div class="content-card">
                        <h4>Members</h4>
                        <p>{contentTotals.members.toLocaleString()}</p>
                    </div>
                    <div class="content-card">
                        <h4>Actions</h4>
                        <p>{contentTotals.actions.toLocaleString()}</p>
                    </div>
                    <div class="content-card">
                        <h4>Sounds</h4>
                        <p>{contentTotals.sounds.toLocaleString()}</p>
                    </div>
                    <div class="content-card">
                        <h4>Motions</h4>
                        <p>{contentTotals.motions.toLocaleString()}</p>
                    </div>
                    <div class="content-card">
                        <h4>Sights</h4>
                        <p>{contentTotals.sights.toLocaleString()}</p>
                    </div>
                    <div class="content-card">
                        <h4>Words</h4>
                        <p>{contentTotals.words.toLocaleString()}</p>
                    </div>
                </div>
            </section>
        )
    }

    {
        topPagesOverall.length > 0 && (
            <section>
                <h3>Top pages overall</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th scope="col">Path</th>
                                <th scope="col">Views</th>
                            </tr>
                        </thead>
                        <tbody>
                            {topPagesOverall.map((entry) => (
                                <tr>
                                    <td>{entry.path}</td>
                                    <td>{entry.views.toLocaleString()}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </section>
        )
    }

    {
        topPagesWeek.length > 0 && (
            <section>
                <h3>Top pages this week</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th scope="col">Path</th>
                                <th scope="col">Views</th>
                            </tr>
                        </thead>
                        <tbody>
                            {topPagesWeek.map((entry) => (
                                <tr>
                                    <td>{entry.path}</td>
                                    <td>{entry.views.toLocaleString()}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </section>
        )
    }

    {
        latestPageViews.length > 0 && (
            <section>
                <h3>Latest page views</h3>
                <div class="table-wrapper">
                    <table class="wide-table">
                        <thead>
                            <tr>
                                <th scope="col">Time</th>
                                <th scope="col">Path</th>
                                <th scope="col" class="nowrap">
                                    Status
                                </th>
                                <th scope="col">Referrer</th>
                            </tr>
                        </thead>
                        <tbody>
                            {latestPageViews.map((entry) => (
                                <tr>
                                    <td>{entry.createdAt.toLocaleString()}</td>
                                    <td>{entry.path}</td>
                                    <td>{entry.status}</td>
                                    <td>{entry.referrer ?? ""}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </section>
        )
    }
</Layout>

<style>
    section {
        display: flex;
        flex-direction: column;
        gap: 1lh;
    }

    .table-wrapper {
        overflow-x: auto;
    }

    .summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(16ch, 1fr));
        gap: 2ch;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th,
    td {
        padding: calc(0.5lh - var(--border-thickness))
            calc(1ch - var(--border-thickness));
        border: var(--border-thickness) solid var(--text-color);
        text-align: left;
        overflow-wrap: anywhere;
    }

    th {
        text-transform: uppercase;
        font-size: 0.8em;

        &.nowrap {
            overflow-wrap: normal;
        }
    }

    tbody tr:nth-child(even) {
        background-color: color-mix(
            in srgb,
            var(--background-color) 80%,
            var(--text-color) 20%
        );
    }

    .content-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(14ch, 1fr));
        gap: 1ch;
    }

    .content-card {
        border: var(--border-thickness) solid var(--text-color);
        padding: calc(1lh - var(--border-thickness));
    }

    .content-card h4 {
        margin: 0 0 0.25lh;
        text-transform: uppercase;
        font-size: 0.8em;
    }

    .content-card p {
        margin: 0;
    }

    .wide-table {
        min-width: 60ch;
    }

    @media (max-width: 700px) {
        table {
            font-size: 0.9em;
        }

        th,
        td {
            white-space: nowrap;
        }

        td:nth-child(2),
        td:nth-child(5) {
            overflow: hidden;
            text-overflow: ellipsis;
        }
    }
</style>
