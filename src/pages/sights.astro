---
import { readdir } from "node:fs/promises";
import SightsList from "../components/Sights/SightsList.svelte";
import { desc, eq, getTableColumns } from "drizzle-orm";
import db from "../database/db";
import { Member, Sight } from "../database/schema";
import Layout from "../layouts/Layout.astro";
import { thingColourHandler } from "../server/thingUtils";

export const prerender = false;

if (!process.env.SIGHTS_UPLOAD_DIRECTORY) {
    return new Response("SIGHTS_UPLOAD_DIRECTORY not set", { status: 500 });
}

const sights = await db
    .select({
        ...getTableColumns(Sight),
        memberColor: Member.color,
    })
    .from(Sight)
    .innerJoin(Member, eq(Sight.memberDiscord, Member.discord))
    .where(eq(Sight.deleted, false))
    .orderBy(desc(Sight.id))
    .then(thingColourHandler);

const filenames = await readdir(process.env.SIGHTS_UPLOAD_DIRECTORY, {
    recursive: true,
});
const thumbFilenamesById: Record<number, string[]> = {};
const fullFilenamesById: Record<number, string[]> = {};

for (const path of filenames) {
    const parts = path.split("/");

    if (parts.length !== 3) {
        continue;
    }

    const sightId = Number(parts[0]!);
    const type = parts[1]!;
    const filename = parts[2]!;

    switch (type) {
        case "original":
            fullFilenamesById[sightId] ??= [];
            fullFilenamesById[sightId].push(filename);
            break;
        case "thumbs":
            thumbFilenamesById[sightId] ??= [];
            thumbFilenamesById[sightId].push(filename);
            break;
    }
}

const toSlug = (value: string) =>
    value.toLowerCase().replaceAll(/[\s_-]+/g, "-");
const makeSightUrl = (sightId: number, title: string) =>
    new URL(`/sights/${sightId}-${toSlug(title)}`, Astro.url).toString();
const toFullImageUrls = (sightId: number) =>
    (fullFilenamesById[sightId] ?? []).map((filename) =>
        new URL(
            `/sights-uploads/${sightId}/original/${filename}`,
            Astro.url
        ).toString()
    );

const sightsSchema = {
    "@context": "https://schema.org",
    "@type": "ItemList",
    name: "LaTeX 4000 Sights",
    url: Astro.url.toString(),
    itemListElement: sights.slice(0, 25).map((sight, index) => {
        const thumb = thumbFilenamesById[sight.id]?.[0];
        const images = toFullImageUrls(sight.id);

        return {
            "@type": "ListItem",
            position: index + 1,
            url: makeSightUrl(sight.id, sight.title),
            item: {
                "@type": "VisualArtwork",
                name: sight.title,
                description: sight.description,
                creator: "L",
                dateCreated: sight.date.toISOString(),
                image: images.length > 0 ? images : undefined,
                thumbnailUrl:
                    thumb != null
                        ? new URL(
                              `/sights-uploads/${sight.id}/thumbs/${thumb}`,
                              Astro.url
                          ).toString()
                        : undefined,
                keywords: sight.tags,
            },
        };
    }),
};

const activeSightId =
    typeof Astro.locals.sightId === "number" ? Astro.locals.sightId : undefined;
const activeSight =
    activeSightId != null
        ? sights.find((sight) => sight.id === activeSightId)
        : undefined;

const activeSightSchema = activeSight
    ? {
          "@context": "https://schema.org",
          "@type": "VisualArtwork",
          name: activeSight.title,
          description: activeSight.description,
          creator: "L",
          dateCreated: activeSight.date.toISOString(),
          url: makeSightUrl(activeSight.id, activeSight.title),
          ...(() => {
              const images = toFullImageUrls(activeSight.id);
              return images.length > 0 ? { image: images } : {};
          })(),
          keywords: activeSight.tags,
      }
    : undefined;
---

<Layout
    header="Sights"
    title="Sights"
    description="Sights created by the LaTeX 4000 Collective"
>
    <script
        is:inline
        type="application/ld+json"
        set:html={JSON.stringify(sightsSchema)}
    />
    {
        activeSightSchema ? (
            <script
                is:inline
                type="application/ld+json"
                set:html={JSON.stringify(activeSightSchema)}
            />
        ) : undefined
    }
    <p>Welcome to my web sight we got {sights.length} sights</p>
    <noscript>
        <p>JavaScript is required to view the full-size images</p>
    </noscript>
    <SightsList {sights} {thumbFilenamesById} {fullFilenamesById} client:load />
</Layout>

<script is:inline define:vars={{ sightId: Astro.locals.sightId }}>
    if (sightId != null) {
        document
            .querySelector(`.sight[data-sight-id="${sightId}"]`)
            ?.scrollIntoView();
    }
</script>
